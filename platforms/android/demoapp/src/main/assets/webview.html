<!--
  ~
  ~ Copyright (c) 2019, Salesforce.com, inc.
  ~ All rights reserved.
  ~ SPDX-License-Identifier: BSD-3-Clause
  ~ For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/BSD-3-Clause
  ~
  -->

<html>
<head>
    <style> body {padding:20px;} input {margin-right: 10px; padding: 8px; font-size: 18px;}</style>
</head>
<body>
<p>
    <input id='scanSingleBarcode' type='button' onClick='startScanning(false)'
           value='Scan Single Barcode'/><br>
</p>
<p>
    <input id='scanContinuousBarcode' type='button' onClick='startScanning(true)'
           value='Scan Continuously'/>
    <input id='stopContinuousBarcodeScan' type='button' onClick='stopScanning()' value='Stop'/>
</p>
<div id="result"></div>
</body>
<script>

let barcodeScanner = __nimbus.plugins.barcodeScanner;
let deviceInfoPlugin = __nimbus.plugins.DeviceInfoPlugin;
let continuousScan = false;
let barcodesScanned = [];

function setResult(value){
    document.querySelector("#result").innerHTML = value;
}

let barcodeScannerCallback =
    (barcode, error) => {
        console.log(barcode);
        if (barcode !== null) {
            barcodesScanned.push("type: " + barcode.type + " value: " + decodeURIComponent(barcode.value) + "<br>");
            setResult(barcodesScanned.join(""));
            if (continuousScan){
                setTimeout(function() { barcodeScanner.resumeCapture(barcodeScannerCallback);}, 500)
            } else {
                stopScanning()
            }
        } if (error !== null) {
            setResult("<p>error: " + error + "</p>");
        }
    };

if (typeof deviceInfoPlugin !== undefined && deviceInfoPlugin !== null){
    deviceInfoPlugin.getDeviceInfo().then( (deviceInfo) => {
        console.log(deviceInfo);
        setResult("<p>Click Scan Barcode to begin. Current version: " + deviceInfo.appVersion + "</p>");
    });
}

function startScanning(continuous) {
    setResult("")
    barcodesScanned = [];
    continuousScan = continuous;
    if(typeof barcodeScanner !== undefined && barcodeScanner !== null){
        barcodeScanner.beginCapture(
            {"barcodeTypes": ["code128", "code39", "code93", "ean13", "ean8", "upce", "upca", "qr"]},
            barcodeScannerCallback
        );
    }
}

function stopScanning() {
    if(typeof barcodeScanner !== undefined && barcodeScanner !== null){
        barcodeScanner.endCapture()
    }
}



</script>
</html>
